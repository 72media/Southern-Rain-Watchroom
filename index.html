<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Southern Rain Watchroom V12</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

    <style>
        body { margin: 0; font-family: 'Sarabun', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Popup Styles */
        .leaflet-popup-content { font-family: 'Sarabun', sans-serif; font-size: 14px; line-height: 1.4; }
        .rain-val { font-size: 16px; font-weight: bold; }
        .high-rain { color: #d32f2f; font-weight: bold; }
        .med-rain { color: #e65100; font-weight: bold; }
        .low-rain { color: #2e7d32; font-weight: bold; }

        /* Panels */
        #control-panel, #top10-panel {
            position: absolute; top: 10px; z-index: 1000; width: 320px;
            background: rgba(255, 255, 255, 0.95); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px;
            max-height: 90vh; overflow-y: auto; backdrop-filter: blur(5px);
            transition: transform 0.3s ease;
        }
        #control-panel { left: 60px; }
        #top10-panel { right: 10px; display: none; top: 80px; } 
        
        .panel-hidden { transform: translateX(-450px); }
        
        #show-panel-btn {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; border: 2px solid #0d47a1; color: #0d47a1;
            padding: 8px 15px; border-radius: 5px; cursor: pointer;
            font-family: 'Sarabun', sans-serif; font-weight: bold;
            display: none;
        }
        
        #show-right-btn {
            position: absolute; top: 80px; right: 10px; z-index: 1000;
            background: white; border: 2px solid #0d47a1; color: #0d47a1;
            padding: 8px 15px; border-radius: 5px; cursor: pointer;
            font-family: 'Sarabun', sans-serif; font-weight: bold;
            display: none;
        }

        /* Table Styles */
        table.top10-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 5px; }
        table.top10-table th { text-align: left; border-bottom: 2px solid #ddd; padding: 5px; color: #555; }
        table.top10-table td { border-bottom: 1px solid #eee; padding: 8px 5px; cursor: pointer; vertical-align: middle;}
        table.top10-table tr:hover { background-color: #f0f8ff; }
        
        .rank-num { background: #0d47a1; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 20px; font-size: 10px; flex-shrink: 0;}
        .top-1 .rank-num { background: #d32f2f; transform: scale(1.2); } 
        .top-2 .rank-num { background: #e65100; } 
        .top-3 .rank-num { background: #f9a825; }

        .panel-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        .panel-title { 
            color: #0d47a1; font-size: 18px; font-weight: bold; text-decoration: none; 
            cursor: pointer; border-bottom: 1px dashed transparent; transition: all 0.2s;
        }
        .panel-title:hover { color: #1565c0; border-bottom: 1px dashed #1565c0; }

        .btn-minimize { background: none; border: none; font-size: 20px; color: #888; cursor: pointer; line-height: 1; }
        
        #live-clock { font-size: 13px; color: #e65100; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #data-timestamp { font-size: 12px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 5px; }
        
        .upload-group { margin-bottom: 10px; border: 1px dashed #ccc; padding: 10px; border-radius: 6px; background: #f8f9fa; }
        .upload-group label { display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold; }
        .status-text { font-size: 11px; margin-top: 5px; color: #666; }
        
        .layer-item { background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; margin-bottom: 5px; }
        .layer-header { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .slider-container { margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        input[type=range] { flex-grow: 1; height: 3px; }

        /* Forecast Icon Style */
        .custom-forecast-icon {
            background-color: #fff; border: 2px solid #0d47a1; border-radius: 50%;
            text-align: center; line-height: 36px; font-size: 20px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(13, 71, 161, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(13, 71, 161, 0); }
            100% { box-shadow: 0 0 0 0 rgba(13, 71, 161, 0); }
        }
    </style>
</head>
<body>

    <button id="show-panel-btn" onclick="toggleLeftPanel(true)">‚õàÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</button>
    <button id="show-right-btn" onclick="toggleRightPanel(true)">üíß 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ù‡∏ô</button>

    <div id="control-panel">
        <div class="panel-header-row">
            <a href="http://122.155.135.51/aws/contour-map" target="_blank" class="panel-title" title="‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Contour Map">
                ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ù‡∏ô‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ
            </a>
            <button class="btn-minimize" onclick="toggleLeftPanel(false)" title="‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">_</button>
        </div>
        
        <div id="live-clock">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...</div>
        
        <div class="upload-group">
            <label>1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ù‡∏ô (XML, JSON)</label>
            <input type="file" id="rain-file" accept=".xml,.json">
            <div id="rain-status" class="status-text">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>

        <div class="upload-group">
            <label>2. ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥ (.kmz, .kml)</label>
            <input type="file" id="kmz-file" accept=".kmz,.kml" multiple>
            <div id="dem-status" class="status-text">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>
        </div>

        <div class="upload-group">
            <label>3. ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (Yr.no)</label>
            <div style="display:flex; align-items:center; margin-top:5px; background:white; padding:5px; border-radius:4px; border:1px solid #ddd;">
                <input type="checkbox" id="toggle-forecast" style="width:auto; margin-right:8px; cursor:pointer;" onchange="toggleForecastLayer(this)">
                <span style="font-size:13px; color:#0d47a1; font-weight:bold; cursor:pointer;" onclick="document.getElementById('toggle-forecast').click()">‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>
            </div>
        </div>

        <h5>‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥:</h5>
        <div id="layers-list"></div>
    </div>

    <div id="top10-panel">
        <div class="panel-header-row">
            <span class="panel-title" style="font-size:16px;">üíß 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ù‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
            <button class="btn-minimize" onclick="toggleRightPanel(false)">_</button>
        </div>
        <div id="data-timestamp">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div id="top10-content"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([7.2, 100.6], 8);
        var rainLayerGroup = L.layerGroup().addTo(map);
        var forecastLayerGroup = L.layerGroup(); // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà addTo(map) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å
        var rainMarkers = {};
        var currentRainList = [];
        var stationDB = {};

        var googleHybrid = L.tileLayer("https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{ maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: "Google" });
        var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "OSM" });
        var topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", { maxZoom: 17, attribution: "OpenTopo" });
        googleHybrid.addTo(map); 
        L.control.layers({ "Google Hybrid": googleHybrid, "OpenStreetMap": osm, "OpenTopoMap": topo }).addTo(map);

        // --- 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (Forecast) ---
        var forecastIcon = L.divIcon({
            className: 'custom-forecast-icon',
            html: "‚õàÔ∏è",
            iconSize: [36, 36],
            iconAnchor: [18, 18],
            popupAnchor: [0, -20]
        });

        var forecastStations = [
            { name: "‡∏≠.‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà (‡∏™‡∏á‡∏Ç‡∏•‡∏≤)", lat: 7.0084, lng: 100.4767, id: "1610780" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏Ç‡∏•‡∏≤", lat: 7.1756, lng: 100.6143, id: "1606147" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", lat: 6.8696, lng: 101.2501, id: "1607978" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏¢‡∏∞‡∏•‡∏≤", lat: 6.5400, lng: 101.2813, id: "1604870" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", lat: 6.4255, lng: 101.8253, id: "1608409" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏ï‡∏π‡∏•", lat: 6.6238, lng: 100.0674, id: "1606376" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", lat: 7.6167, lng: 100.0833, id: "1607779" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á", lat: 7.5563, lng: 99.6114, id: "1150007" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", lat: 8.4333, lng: 99.9667, id: "1151933" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", lat: 9.1482, lng: 99.3262, id: "1150515" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", lat: 8.0726, lng: 98.9105, id: "1152633" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", lat: 7.8804, lng: 98.3923, id: "1151254" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏∞‡∏ô‡∏≠‡∏á", lat: 9.9658, lng: 98.6348, id: "1150965" },
            { name: "‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏û‡∏£", lat: 10.4930, lng: 99.1800, id: "1153557" },
            { name: "‡∏≠.‡πÄ‡∏ö‡∏ï‡∏á (‡∏¢‡∏∞‡∏•‡∏≤)", lat: 5.7743, lng: 101.0711, id: "1611635" },
            { name: "‡∏≠.‡∏£‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏ö‡∏π‡∏•‡∏¢‡πå", lat: 8.17911, lng: 99.85425, id: "1150921" },
            { name: "‡∏≠.‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏°‡∏∏‡∏¢", lat: 9.53567, lng: 99.93567, id: "1154689" },
            { name: "‡∏≠.‡∏ó‡∏∏‡πà‡∏á‡∏™‡∏á (‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏Ø)", lat: 8.1646, lng: 99.6804, id: "1150085" },
            { name: "‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏µ‡∏£‡∏µ‡∏ß‡∏á", lat: 8.43045, lng: 99.78104, id: "1119630" },
            { name: "‡πÄ‡∏Ç‡∏≤‡∏£‡∏≤‡∏°‡πÇ‡∏£‡∏°", lat: 8.23353, lng: 99.79172, id: "8242731" },
            { name: "‡πÄ‡∏Ç‡∏≤‡∏´‡∏•‡∏ß‡∏á", lat: 8.54658, lng: 99.73331, id: "8243612" },
            { name: "‡∏≠.‡∏™‡∏∏‡πÑ‡∏´‡∏á‡πÇ‡∏Å-‡∏•‡∏Å (‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™)", lat: 6.0298, lng: 101.9659, id: "1606050" }
        ];

        forecastStations.forEach(item => {
            var marker = L.marker([item.lat, item.lng], { icon: forecastIcon }).addTo(forecastLayerGroup);
            var svgUrl = `https://www.yr.no/en/content/2-${item.id}/meteogram.svg`;
            var detailUrl = `https://www.yr.no/en/details/graph/2-${item.id}`; 
            
            var popupContent = `
                <div style="text-align:center; min-width: 320px;">
                    <h4 style="margin:0 0 5px; color:#0d47a1;">${item.name}</h4>
                    <p style="font-size:12px; color:gray; margin-bottom:5px;">‡∏Å‡∏£‡∏≤‡∏ü‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå 48 ‡∏ä‡∏°. (Yr.no)</p>
                    <div style="background:white; padding:5px; border:1px solid #eee; border-radius:5px; margin-bottom:10px;">
                        <img src="${svgUrl}" style="width:100%; height:auto; display:block;">
                    </div>
                    
                    <a href="${detailUrl}" target="_blank" style="text-decoration:none;">
                        <div style="background:#0d47a1; color:white; padding:8px; border-radius:4px; cursor:pointer; font-size:13px; font-weight:bold;">
                            üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà ‚Üó)
                        </div>
                    </a>
                </div>
            `;
            marker.bindPopup(popupContent, { maxWidth: 650 });
        });

        // --- Toggle Forecast Layer ---
        function toggleForecastLayer(chk) {
            if (chk.checked) {
                forecastLayerGroup.addTo(map);
            } else {
                forecastLayerGroup.remove();
            }
        }

        // --- Dictionary & Others ---
        const nameDict = {
            "Automatic Weather Station": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", "Weather Observing Station": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", "Agrometeorological Station": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£", "Weather Radar Station": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡πÄ‡∏£‡∏î‡∏≤‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "Hydrometeorlogical Station": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏∏‡∏ó‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", "Airport": "‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô", "Dam": "‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô", "Reservoir": "‡∏≠‡πà‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥", "City": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "Amphoe Mueang": "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
            "Narathiwat": "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "Pattani": "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "Yala": "‡∏¢‡∏∞‡∏•‡∏≤", "Songkhla": "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "Phatthalung": "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "Trang": "‡∏ï‡∏£‡∏±‡∏á", "Satun": "‡∏™‡∏ï‡∏π‡∏•", "Nakhon Si Thammarat": "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "Surat Thani": "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "Krabi": "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "Phuket": "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "Phang Nga": "‡∏û‡∏±‡∏á‡∏á‡∏≤", "Ranong": "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "Chumphon": "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "Prachuap Khiri Khan": "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå",
            "Hat Yai": "‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà", "Bacho": "‡∏ö‡∏≤‡πÄ‡∏à‡∏≤‡∏∞", "Yi-ngo": "‡∏¢‡∏µ‡πà‡∏á‡∏≠", "Takbai": "‡∏ï‡∏≤‡∏Å‡πÉ‡∏ö", "Rueso": "‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏≤‡∏∞", "Si Sakhon": "‡∏®‡∏£‡∏µ‡∏™‡∏≤‡∏Ñ‡∏£", "Waeng": "‡πÅ‡∏ß‡πâ‡∏á", "Sukhirin": "‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô", "Su-ngai Kolok": "‡∏™‡∏∏‡πÑ‡∏´‡∏á‡πÇ‡∏Å-‡∏•‡∏Å", "Su-ngai Padi": "‡∏™‡∏∏‡πÑ‡∏´‡∏á‡∏õ‡∏≤‡∏î‡∏µ", "Chanae": "‡∏à‡∏∞‡πÅ‡∏ô‡∏∞", "Cho-airong": "‡πÄ‡∏à‡∏≤‡∏∞‡πÑ‡∏≠‡∏£‡πâ‡∏≠‡∏á", "Kapho": "‡∏Å‡∏∞‡∏û‡πâ‡∏≠", "Mai Kaen": "‡πÑ‡∏°‡πâ‡πÅ‡∏Å‡πà‡∏ô", "Mayo": "‡∏°‡∏≤‡∏¢‡∏≠", "Nong Chik": "‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å", "Panare": "‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞", "Sai Buri": "‡∏™‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏µ", "Thung Yang Daeng": "‡∏ó‡∏∏‡πà‡∏á‡∏¢‡∏≤‡∏á‡πÅ‡∏î‡∏á", "Yarang": "‡∏¢‡∏∞‡∏£‡∏±‡∏á", "Yaring": "‡∏¢‡∏∞‡∏´‡∏£‡∏¥‡πà‡∏á", "Mae Lan": "‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô", "Maelan": "‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô", "Khok Pho": "‡πÇ‡∏Ñ‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡πå", "Betong": "‡πÄ‡∏ö‡∏ï‡∏á", "Bannang Sata": "‡∏ö‡∏±‡∏ô‡∏ô‡∏±‡∏á‡∏™‡∏ï‡∏≤", "Than To": "‡∏ò‡∏≤‡∏£‡πÇ‡∏ï", "Yaha": "‡∏¢‡∏∞‡∏´‡∏≤", "Raman": "‡∏£‡∏≤‡∏°‡∏±‡∏ô", "Krong Pinang": "‡∏Å‡∏£‡∏á‡∏õ‡∏¥‡∏ô‡∏±‡∏á", "Kabang": "‡∏Å‡∏≤‡∏ö‡∏±‡∏á", "Sadao": "‡∏™‡∏∞‡πÄ‡∏î‡∏≤", "Chana": "‡∏à‡∏∞‡∏ô‡∏∞", "Thepha": "‡πÄ‡∏ó‡∏û‡∏≤", "Na Thawee": "‡∏ô‡∏≤‡∏ó‡∏ß‡∏µ", "Saba Yoi": "‡∏™‡∏∞‡∏ö‡πâ‡∏≤‡∏¢‡πâ‡∏≠‡∏¢", "Sathing Phra": "‡∏™‡∏ó‡∏¥‡∏á‡∏û‡∏£‡∏∞", "Kho Hong": "‡∏Ñ‡∏≠‡∏´‡∏á‡∏™‡πå", "Phikuntong": "‡∏û‡∏¥‡∏Å‡∏∏‡∏•‡∏ó‡∏≠‡∏á", "Tha Ngio": "‡∏ó‡πà‡∏≤‡∏á‡∏¥‡πâ‡∏ß", "Bangjak": "‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å", "Chawang": "‡∏â‡∏ß‡∏≤‡∏á", "Phrasang": "‡∏û‡∏£‡∏∞‡πÅ‡∏™‡∏á", "Klong Tha Din Dang": "‡∏Ñ‡∏•‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á", "Sawi": "‡∏™‡∏ß‡∏µ", "Kanjanadit": "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏î‡∏¥‡∏©‡∏ê‡πå", "Prasong": "‡∏û‡∏£‡∏∞‡πÅ‡∏™‡∏á", "Hua Hin": "‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô", "Nong Plub": "‡∏´‡∏ô‡∏≠‡∏á‡∏û‡∏•‡∏±‡∏ö", "Pran Buri": "‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "Khlong Bueng": "‡∏Ñ‡∏•‡∏≠‡∏á‡∏ö‡∏∂‡∏á", "Thap Sakae": "‡∏ó‡∏±‡∏ö‡∏™‡∏∞‡πÅ‡∏Å", "Ratchaprapha": "‡∏£‡∏±‡∏ä‡∏ä‡∏õ‡∏£‡∏∞‡∏†‡∏≤", "Tha Thong": "‡∏ó‡πà‡∏≤‡∏ó‡∏≠‡∏á", "Ko Samui": "‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏°‡∏∏‡∏¢", "Ko Lanta": "‡πÄ‡∏Å‡∏≤‡∏∞‡∏•‡∏±‡∏ô‡∏ï‡∏≤", "Bang Kamprad": "‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏î", "Bang Ward": "‡∏ö‡∏≤‡∏á‡∏ß‡∏≤‡∏î"
        };

        function translateName(engName) {
            if (!engName) return engName;
            let thaiName = engName;
            Object.keys(nameDict).forEach(key => {
                const regex = new RegExp(key, "gi");
                thaiName = thaiName.replace(regex, nameDict[key]);
            });
            return thaiName;
        }

        function toggleLeftPanel(show) {
            const panel = document.getElementById('control-panel');
            const btn = document.getElementById('show-panel-btn');
            if (show) { panel.classList.remove('panel-hidden'); btn.style.display = 'none'; } 
            else { panel.classList.add('panel-hidden'); setTimeout(() => { btn.style.display = 'block'; }, 300); }
        }

        function toggleRightPanel(show) {
            const panel = document.getElementById('top10-panel');
            const btn = document.getElementById('show-right-btn');
            if (show) { 
                panel.style.display = 'block';
                btn.style.display = 'none'; 
            } else { 
                panel.style.display = 'none';
                btn.style.display = 'block'; 
            }
        }

        function startClock() {
            const update = () => {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                document.getElementById('live-clock').innerHTML = `üïí ${now.toLocaleDateString('th-TH', options)} ‡∏ô.`;
            };
            setInterval(update, 1000); update();
        }
        startClock();

        function getRainColor(val) { return val >= 90 ? '#d32f2f' : val >= 35 ? '#f57c00' : val > 0 ? '#2e7d32' : '#757575'; }
        function getRainClass(val) { return val >= 90 ? 'high-rain' : val >= 35 ? 'med-rain' : 'low-rain'; }
        
        function updateTimeDisplay() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('data-timestamp').innerHTML = `üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì: <strong>${now.toLocaleDateString('th-TH', options)} ‡∏ô.</strong>`;
        }

        function processStationData(lat, lng, name, province, rain, id) {
            if (id && lat && lng) { stationDB[id] = { lat: lat, lng: lng, name: name || id, province: province || "" }; }
            var thaiName = translateName(name || id);
            var thaiProvince = translateName(province || "");
            var color = getRainColor(rain);
            var rainClass = getRainClass(rain);
            var alertIcon = rain >= 90 ? "üö®" : "";

            var marker = L.circleMarker([lat, lng], { color: '#fff', weight: 1.5, fillColor: color, fillOpacity: 1, radius: 9 });
            var popupContent = `<div style="font-size:15px;"><strong>${thaiName}</strong></div><div style="font-size:11px; color:#666;">(${name})</div><small>‡∏à.${thaiProvince}</small><hr style="margin:5px 0;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô: <span class="rain-val ${rainClass}">${rain} ‡∏°‡∏°.</span> ${alertIcon}`;
            marker.bindPopup(popupContent);
            rainLayerGroup.addLayer(marker);
            
            var key = id || (name + lat); 
            rainMarkers[key] = marker;
            currentRainList.push({ id: key, name_th: thaiName, name_en: name, province: thaiProvince, rain: rain, lat: lat, lng: lng });
        }

        function updateTop10Table() {
            currentRainList.sort((a, b) => b.rain - a.rain);
            var top10 = currentRainList.slice(0, 10);
            var html = `<table class="top10-table"><thead><tr><th>#</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</th><th>‡∏ù‡∏ô (‡∏°‡∏°.)</th></tr></thead><tbody>`;
            if (top10.length === 0) { html += `<tr><td colspan="3" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; } 
            else {
                top10.forEach((item, index) => {
                    var rankClass = index === 0 ? 'top-1' : (index === 1 ? 'top-2' : (index === 2 ? 'top-3' : ''));
                    var rainClass = getRainClass(item.rain);
                    html += `<tr onclick="zoomToStation('${item.id}', ${item.lat}, ${item.lng})"><td><span class="rank-num ${rankClass}">${index + 1}</span></td><td><b>${item.name_th}</b><br><span style="color:#888;font-size:10px;">${item.name_en}</span><br><span style="color:#555;font-size:11px;">‡∏à.${item.province}</span></td><td class="${rainClass}" style="text-align:right; font-weight:bold;">${item.rain.toFixed(1)}</td></tr>`;
                });
            }
            html += `</tbody></table>`;
            document.getElementById('top10-content').innerHTML = html;
            document.getElementById('top10-panel').style.display = 'block';
            document.getElementById('show-right-btn').style.display = 'none';
        }

        window.zoomToStation = function(key, lat, lng) {
            map.flyTo([lat, lng], 11, { duration: 1.5 });
            setTimeout(() => { if (rainMarkers[key]) rainMarkers[key].openPopup(); }, 1600);
        };

        document.getElementById('rain-file').addEventListener('change', function(evt) {
            var file = evt.target.files[0]; if (!file) return;
            var status = document.getElementById('rain-status'); status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var content = e.target.result; rainLayerGroup.clearLayers(); rainMarkers = {}; currentRainList = []; var count = 0; var maxRain = 0;
                    if (file.name.toLowerCase().endsWith('.json')) {
                        var jsonData = JSON.parse(content);
                        var list = jsonData.timeSeriesObservation ? jsonData.timeSeriesObservation : jsonData;
                        list.forEach(item => {
                            var lat, lng, name, province, rain, id;
                            if (item.station && item.measurementResults) { 
                                id = item.station.stationCode; var latest = item.measurementResults[item.measurementResults.length - 1]; rain = parseFloat(latest.value);
                                if (stationDB[id]) { lat = stationDB[id].lat; lng = stationDB[id].lng; name = stationDB[id].name; province = stationDB[id].province; }
                            } else {
                                lat = parseFloat(item.latitude); lng = parseFloat(item.longitude); rain = parseFloat(item.sensor_data); id = item.site_id || item.stationCode; name = item.site_name; province = item.province_name_en;
                            }
                            if (!isNaN(lat) && !isNaN(lng)) { processStationData(lat, lng, name, province, rain, id); if (rain > maxRain) maxRain = rain; count++; }
                        });
                    } else { 
                        var parser = new DOMParser(); var items = parser.parseFromString(content, "text/xml").getElementsByTagName("Item");
                        for (var i = 0; i < items.length; i++) {
                            var lat = parseFloat(items[i].getElementsByTagName("latitude")[0]?.textContent); var lng = parseFloat(items[i].getElementsByTagName("longitude")[0]?.textContent); var name = items[i].getElementsByTagName("site_name")[0]?.textContent; var id = items[i].getElementsByTagName("site_id")[0]?.textContent; var province = items[i].getElementsByTagName("province_name_en")[0]?.textContent; var rain = parseFloat(items[i].getElementsByTagName("sensor_data")[0]?.textContent);
                            if (!isNaN(lat) && !isNaN(lng)) { processStationData(lat, lng, name, province, rain, id); if (rain > maxRain) maxRain = rain; count++; }
                        }
                    }
                    updateTop10Table(); updateTimeDisplay();
                    status.innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß (${count} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ)<br>‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${maxRain} ‡∏°‡∏°.`; status.style.color = count > 0 ? "green" : "orange";
                } catch (err) { console.error(err); status.innerText = "‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö"; status.style.color = "red"; }
            };
            reader.readAsText(file);
        });

        document.getElementById('kmz-file').addEventListener('change', function(evt) {
            var files = evt.target.files; if (!files.length) return;
            var status = document.getElementById('dem-status'); status.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...`;
            Array.from(files).forEach(file => {
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (file.name.toLowerCase().endsWith('.kmz')) {
                        JSZip.loadAsync(e.target.result).then(zip => {
                            var kmlKey = Object.keys(zip.files).find(n => n.toLowerCase().endsWith('.kml'));
                            if (kmlKey) zip.file(kmlKey).async("string").then(txt => processKML(txt, zip, file.name));
                        });
                    } else if (file.name.toLowerCase().endsWith('.kml')) {
                        var tr = new FileReader(); tr.onload = (eText) => processKML(eText.target.result, null, file.name); tr.readAsText(file);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            setTimeout(() => { status.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"; }, 2000); evt.target.value = ''; 
        });

        function processKML(xmlText, zipObj, fileName) {
            var parser = new DOMParser(); var xml = parser.parseFromString(xmlText, "text/xml");
            var overlays = xml.getElementsByTagName("GroundOverlay"); var layerGroup = L.layerGroup().addTo(map); var hasContent = false;
            if (overlays.length > 0) {
                Array.from(overlays).forEach(overlay => {
                    var href = overlay.getElementsByTagName("href")[0]?.textContent.trim(); var box = overlay.getElementsByTagName("LatLonBox")[0];
                    if (href && box) {
                        var bounds = [[parseFloat(box.getElementsByTagName("south")[0].textContent), parseFloat(box.getElementsByTagName("west")[0].textContent)],[parseFloat(box.getElementsByTagName("north")[0].textContent), parseFloat(box.getElementsByTagName("east")[0].textContent)]];
                        if (zipObj) {
                            var imgFile = zipObj.file(href) || zipObj.file(Object.keys(zipObj.files).find(n => n.endsWith(href.split('/').pop())));
                            if (imgFile) { imgFile.async("blob").then(blob => { L.imageOverlay(URL.createObjectURL(blob), bounds, { opacity: 1.0 }).addTo(layerGroup); map.fitBounds(bounds); }); hasContent = true; }
                        } else { L.imageOverlay(href, bounds, { opacity: 1.0 }).addTo(layerGroup); hasContent = true; }
                    }
                });
            }
            if (!hasContent) { 
                var geojson = toGeoJSON.kml(xml); if (geojson.features.length > 0) { L.geoJSON(geojson, { style: { color: 'blue', weight: 2 } }).addTo(layerGroup); map.fitBounds(L.geoJSON(geojson).getBounds()); hasContent = true; }
            }
            if (hasContent) addLayerControl(fileName, layerGroup);
        }

        function addLayerControl(name, layer) {
            var id = 'lyr-' + Math.random().toString(36).substr(2,9); var div = document.createElement('div'); div.className = 'layer-item';
            div.innerHTML = `<div class="layer-header"><div><input type="checkbox" checked onchange="toggleLayer('${id}', this)"> <span class="layer-name" title="${name}">${name}</span></div><span class="btn-close" onclick="removeLayer('${id}')">√ó</span></div><div class="slider-container"><input type="range" min="0" max="100" value="100" oninput="setOpacity('${id}', this)"><span class="opacity-label" id="op-${id}">100%</span></div>`;
            div.id = `div-${id}`; div.layerRef = layer; document.getElementById('layers-list').appendChild(div);
        }

        window.toggleLayer = (id, chk) => { var el = document.getElementById(`div-${id}`); chk.checked ? el.layerRef.addTo(map) : el.layerRef.remove(); }
        window.setOpacity = (id, rng) => { var val = rng.value/100; document.getElementById(`op-${id}`).innerText = rng.value+"%"; var el = document.getElementById(`div-${id}`); el.layerRef.eachLayer(lyr => { if(lyr.setOpacity) lyr.setOpacity(val); if(lyr.setStyle) lyr.setStyle({opacity:val, fillOpacity:val*0.5}); }); }
        window.removeLayer = (id) => { var el = document.getElementById(`div-${id}`); el.layerRef.remove(); el.remove(); }
    </script>
</body>
</html>
